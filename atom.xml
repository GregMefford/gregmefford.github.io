<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[acts_as_engineer]]></title>
  <link href="http://www.gregmefford.com/atom.xml" rel="self"/>
  <link href="http://www.gregmefford.com/"/>
  <updated>2016-01-22T21:50:35-05:00</updated>
  <id>http://www.gregmefford.com/</id>
  <author>
    <name><![CDATA[Greg Mefford]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Driving NeoPixels with Elixir and Nerves]]></title>
    <link href="http://www.gregmefford.com/blog/2016/01/22/driving-neopixels-with-elixir-and-nerves/"/>
    <updated>2016-01-22T22:41:20-05:00</updated>
    <id>http://www.gregmefford.com/blog/2016/01/22/driving-neopixels-with-elixir-and-nerves</id>
    <content type="html"><![CDATA[<p>Before starting this project, I was looking for a project I could use to learn <a href="http://elixir-lang.org">Elixir</a>. I&rsquo;d been hearing great things about it, played with it a little on <a href="http://exercism.io">Exercism</a>, and went to a local Elixir meetup a couple of times.</p>

<p>Then I saw the talk <a href="https://www.youtube.com/watch?v=kpzQrFC55q4">&ldquo;Embedded Elixir in Action&rdquo; by Garth Hitchens</a> about using <a href="http://nerves-project.org">Nerves</a> to develop real-world Elixir-based embedded systems.
I&rsquo;d had an original <a href="https://www.raspberrypi.org/products/model-b/">Raspberry Pi B</a> sitting on a shelf for a few years, so this seemed like it would be a good opportunity to learn Elixir and finally use that hardware for something.
I also had a bunch of <a href="https://www.adafruit.com/category/168">WS2812B &ldquo;NeoPixel&rdquo; RGB LEDs</a> that I was itching for an excuse to use for something.
(Caution: If you browse the available NeoPixel products on Adafruit, you may not be able to resist buying something).</p>

<p>At this point, I was unable to resist hitting these three birds with one stone!</p>

<!-- more -->


<h2>A Brief Introduction</h2>

<p>I started this project pretty new to Elixir, having just begun to read <a href="https://pragprog.com/book/elixir/programming-elixir">&ldquo;Programming Elixir&rdquo; by Dave Thomas</a>.
I also wasn&rsquo;t familiar with embedded systems development beyond writing some hobbyist C code for AVR microcontrollers in the distant past.
I want to take an opportunity to chime in with the other voices in saying that you don&rsquo;t have to really understand all these things deeply in order to get started and build a useful project.</p>

<p>The journey was a lot of fun for me and I hope to share some of my excitement with you!</p>

<h3>Elixir, Erlang, and Processes</h3>

<p>Elixir is a functional programming language that runs on the Erlang virtual machine, called BEAM.
This is just like how the Java Virtual Machine (JVM) was designed for running Java code, but can also host code written in other languages, like Clojure.
In both cases, a brand-new language (i.e. Elixir or Clojure) was born with an already-robust, production-ready run-time environment instead of starting from scratch.</p>

<p>Besides being a functional language, Elixir has a few other key concepts to understand when you&rsquo;re getting started.
In Elixir, the code is arranged as functions that are grouped into Modules, which normally run many Processes in order to accomplish their purpose.
Elixir code is basically designed around each Process being a tiny <a href="http://martinfowler.com/articles/microservices.html">microservice</a> sends and responds to messages from other Processes.
If this concept just blew your mind, check out Chris Nelson&rsquo;s talk from CodeMash 2016: <a href="https://www.codemash.org/session/low-ceremony-microservices-with-elixir/">Low Ceremony Microservices with Elixir</a>.</p>

<p>These Processes in the Erlang VM are much more lightweight than an Operating System process, so it&rsquo;s not unusual to have many thousands of them running at any time, much as you might have many Objects instantiated in a Ruby-based system.
Also similar to Ruby&rsquo;s Objects, a Process in Elixir is how state is stored and accessed, by passing messages between Processes.</p>

<p>Speaking of state, it&rsquo;s also worth mentioning that the data structures in Elixir are all immutable.
When the state of a Process needs to be changed, it is accomplished by replacing its state with a new state rather than modifying parts of the state in-place.
This is probably confusing at first for a new Elixir programmer, but it quickly becomes natural and enables Elixir to do some great things under the hood to enable efficient concurrency and garbage-collection.</p>

<h3>OTP and Applications</h3>

<p>OTP is a <em>really</em> cool feature that Elixir inherits from its Erlang heritage.
One thing that wasn&rsquo;t obvious to me at first is that what a developer might normall call an &lsquo;application&rsquo; is, in OTP terms, a collection on interacting OTP Applications.
For example, if you want to log things to <code>stdout</code> or <code>stderr</code>, you might include the <code>Logger</code> Application in your <code>mix.exs</code> file, like this:</p>

<figure class='code'><figcaption><span>mix.exs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="k">defmodule</span> <span class="no">MyProject</span><span class="o">.</span><span class="no">Mixfile</span> <span class="k">do</span>
</span><span class='line'><span class="k">  </span><span class="kn">use</span> <span class="no">Mix</span><span class="o">.</span><span class="no">Project</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">application</span> <span class="k">do</span>
</span><span class='line'><span class="k">    </span><span class="p">[</span>
</span><span class='line'>      <span class="ss">applications:</span> <span class="p">[</span><span class="ss">:logger</span><span class="p">],</span>
</span><span class='line'>      <span class="ss">mod:</span> <span class="p">{</span><span class="no">MyProject</span><span class="p">,</span> <span class="p">[]}</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, when you run your project, the <code>mod</code> option says that the <code>MyProject</code> Module will start the supervision tree for my top-level Application.
The <code>applications</code> option says to also start additional OTP Application(s), their process(es) waiting to receive messages from other Processes.</p>

<p>There is plenty more to learn about OTP, but you&rsquo;ll probably learn best by just reading up on it and trying it out for yourself.
The official Elixir <a href="http://elixir-lang.org/getting-started/mix-otp/">Getting-Started Introduction to Mix and OTP</a> is, unsurprisingly, a great place to start.</p>

<p>Onward and upward, to the main point!</p>

<h2>Getting Started with Nerves</h2>

<p>Having established how fun and exciting Elixir is, let&rsquo;s get some Elixir code running on a Raspberry Pi (or similar Linux-based embedded development platform).
The tool to accomplish this is called <a href="http://nerves-project.org">Nerves</a>.
In a nutshell, Nerves wraps up the <a href="https://buildroot.org">Buildroot</a> tool, making it trivially easy to cross-compile a stripped-down Linux image for your target platform of choice.</p>

<p>As of this writing, there&rsquo;s a brand-new tool called <a href="http://www.bakeware.io">Bakeware</a> that can be used to simplify the process I&rsquo;m going to describe below for many common use-cases.
Wendy Smoak recently wrote a <a href="http://wsmoak.net/2016/01/11/embedded-elixir-nerves-bake.html">blog post explaining how to use Bakeware</a>, so check that out if you&rsquo;re interested.
Bakeware will probably be the preferred method of interacting with Nerves for most people going forward.
Since it didn&rsquo;t exist when I started this project and you might be curious what Bakeware does behind the scenes, I&rsquo;ll explain the lower-level method I&rsquo;ve been using.</p>

<h3>Setting up a Nerves Build Environment</h3>

<p>Much has been written about how to get Nerves running on Mac OSX, so I&rsquo;m going to describe how to do it using a Windows machine with access to a Linux VM.
On the Windows side, I&rsquo;m using Windows 10, but that probably isn&rsquo;t relevant because Windows isn&rsquo;t doing anything special here.
For Linux, I&rsquo;m using <strong>Ubuntu 14.04</strong> since the Nerves website describes how to get started on Ubuntu.
If you want to try it on another distribution, you&rsquo;ll have to figure out which equivalent packages to use.</p>

<p>From a fresh install of Ubuntu, you&rsquo;ll need to install the following packages to get started:</p>

<figure class='code'><figcaption><span>bash</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">sudo apt-get install git g++ libssl-dev libncurses5-dev bc m4 make unzip</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, check out the main Nerves repository:</p>

<figure class='code'><figcaption><span>bash</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">git clone git@github.com:nerves-project/nerves-system-br.git</span>
</span></code></pre></td></tr></table></div></figure>


<p>After that finishes, run <code>make help</code> to get a list of supported platforms:</p>

<figure class='code'><figcaption><span>bash</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">Nerves System Help</span>
</span><span class='line'><span class="go">------------------</span>
</span><span class='line'>
</span><span class='line'><span class="go">Targets:</span>
</span><span class='line'><span class="go">  all                           - Build the current configuration</span>
</span><span class='line'><span class="go">  burn                          - Burn the most recent build to an SDCard (requires sudo)</span>
</span><span class='line'><span class="go">  system                        - Build a system image for use with bake</span>
</span><span class='line'><span class="go">  clean                         - Clean everything - run make xyz_defconfig after this</span>
</span><span class='line'>
</span><span class='line'><span class="go">Configuration:</span>
</span><span class='line'><span class="go">  menuconfig                    - Run Buildroot&#39;s menuconfig</span>
</span><span class='line'><span class="go">  linux-menuconfig              - Run menuconfig on the Linux kernel</span>
</span><span class='line'>
</span><span class='line'><span class="go">Nerves built-in configs:</span>
</span><span class='line'><span class="go">  bbb_linux_defconfig           - Build for bbb_linux</span>
</span><span class='line'><span class="go">  nerves_bbb_elixir_defconfig   - Build for nerves_bbb_elixir</span>
</span><span class='line'><span class="go">  nerves_bbb_erlang_defconfig   - Build for nerves_bbb_erlang</span>
</span><span class='line'><span class="go">  nerves_galileo_elixir_defconfig - Build for nerves_galileo_elixir</span>
</span><span class='line'><span class="go">  nerves_rpi2_elixir_defconfig  - Build for nerves_rpi2_elixir</span>
</span><span class='line'><span class="go">  nerves_rpi2_erlang_defconfig  - Build for nerves_rpi2_erlang</span>
</span><span class='line'><span class="go">  nerves_rpi_elixir_defconfig   - Build for nerves_rpi_elixir</span>
</span><span class='line'><span class="go">  nerves_rpi_erlang_defconfig   - Build for nerves_rpi_erlang</span>
</span><span class='line'><span class="go">  nerves_rpi_lfe_defconfig      - Build for nerves_rpi_lfe</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since my target platform is an original Raspberry Pi Model B, I then ran</p>

<figure class='code'><figcaption><span>bash</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">make nerves_rpi_elixir_defconfig</span>
</span></code></pre></td></tr></table></div></figure>


<p>This sets up the configuration options to build a Linux image that will boot into Elixir&rsquo;s <code>iex</code> shell using the Raspberry Pi&rsquo;s HDMI monitor output.
It&rsquo;s possible to re-configure the terminal to use the UART pins on the board, so that you could connect to it using PuTTY over an FTDI cable, so check out the how-to on <a href="https://github.com/nerves-project/nerves-system-br/blob/master/README.md">the <code>nerves-system-br</code> README</a> if you want to do that.
Instead, I just plugged a monitor into the HDMI port and a USB keyboard into one of the USB ports.</p>

<p>Once the default configuration is done, just run <code>make</code> to build the default system image.
This will probably take a <em>really</em> long time, depending on the speed of your computer, hard drive, Internet connection, etc.</p>

<p>This is ware Bakeware is a win for most use-cases.
It pre-builds these base system images and toolchains ahead of time, so you can simply download and use them right away instead of building them yourself.
Bakeware also eliminates the dependency on Linux, because the images were already &ldquo;baked&rdquo; on Linux with the appropriate kernels, headers, and other various voodoo available.</p>

<figure class='code'><figcaption><span>bash</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">make</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will result in the base firmware image being written to <code>buildroot/output/images/nerves-rpi-base.img</code>.
At this point, I confirmed that things were working properly by copying this <code>.img</code> file to my Windows host machine using <a href="https://winscp.net/">WinSCP</a>, then burned it to an SD card using <a href="http://sourceforge.net/projects/win32diskimager">Win32DiskImager</a>.</p>

<p>Yes, I downloaded and ran a Windows executable (As an Administrator!) from Sourceforge.
I feel bad about it, but apparently, that&rsquo;s just how people get the functionality of <code>dd</code> on Windows.
Let&rsquo;s be honest, it&rsquo;s about the same thing as a sudo-curl-bash installer which has become so common.</p>

<p>After the SD card is done being written, I put it in my Raspberry Pi and booted it up.
Lo and behold, (after only four seconds!) I was greeted by an <code>iex</code> prompt.</p>

<p><img class="center" src="http://www.gregmefford.com/images/posts/2016-01-22-driving-neopixels-with-elixir-and-nerves/nerves_hello_world.jpg" title="Hello World from Elixir and Nerves on a Raspberry Pi" ></p>

<h2>Driving NeoPixels from a Raspberry Pi</h2>

<p>With all that out of the way, we&rsquo;re ready for the actual blinkenlights.
Well, almost.</p>

<p>First, we need a way to drive the 5V NeoPixel data intput using the Raspberry Pi&rsquo;s 3.3V outputs.
One easy way to accomplish this is with a <a href="https://www.adafruit.com/product/1787">74AHCT125 Level-Shifter chip</a>, but I didn&rsquo;t have one laying around and didn&rsquo;t want to order one.
What I <em>did</em> have laying around was an <a href="http://www.mouser.com/ProductDetail/Texas-Instruments/SN74ALS1035N">SN74ALS1035N Non-Inverting Buffer</a>.
The trick was that the inputs happen to accept a High-level input voltage of only 2V, while the outputs are 5V nominal.
Since the outputs are <a href="https://en.wikipedia.org/wiki/Open_collector">open-collector</a>, I had to use a 1k-ohm pull-up resistor from the output to VCC.</p>

<p>The other issue is that I&rsquo;m planning to drive a long strip of WS2812B NeoPixels, which draws far more power than the Raspberry Pi can supply.
I cut the end off an old 5V cell phone charger and put a header on it to simplify bread-boarding, then added a 3300uF 6.3V electrolytic capacitor that I had lying around.
The purpose of the capacitor is to stabilize the voltage being supplied to the strip when the current draw changes suddenly (e.g. when the lights are blinking on and off).</p>

<p>Here&rsquo;s a crude schematic of the circuit, and a picture of the dead-bug sculpture in all its magesty.</p>

<p><img class="center" src="http://www.gregmefford.com/images/posts/2016-01-22-driving-neopixels-with-elixir-and-nerves/schematic.png" title="Schematic of the Adapter Circuit to Drive NeoPixels with a Raspberry Pi" ></p>

<p><img class="center" src="http://www.gregmefford.com/images/posts/2016-01-22-driving-neopixels-with-elixir-and-nerves/neopixel_level_shifter.jpg" title="Picture of the Dead-Bug Circuit to Drive NeoPixels with a Raspberry Pi" ></p>

<p>With the hardware interface figured out, I needed a way to generate the required Pulse-Width-Modulation (PWM) pattern to control the LED colors.
I did a lot of research about how this works and was considering doing it with a low-cost AVR microcontroller that would interface with the Raspberry Pi.
If you&rsquo;re interested in the details, you should check out <a href="http://wp.josh.com/category/neopixel">the NeoPixel posts on josh.com</a>.
This guy did some truly amazing work documenting how the WS2812B &ldquo;NeoPixel&rdquo; works, and how to interface efficiently with it.</p>

<p>In the end, it wasn&rsquo;t necessary, because <a href="https://github.com/jgarff/rpi_ws281x">the rpi_ws281x project</a> makes it possible to directly generate the required patterns using the Raspberry Pi&rsquo;s hardware PWM and Direct Memory Access (DMA) capabilities.</p>

<h2>Building the Elixir Project and Interfacing with C code</h2>

<p>This is the part of the project where I learned a lot about the basics of Elixir projects and a few more obscure details about building native C code as part of a project.</p>

<p>To integrate the <code>rpi_ws281x</code> C library with my Elixir code, I chose to write a little C wrapper around it so that it would accept binary pixel data on <code>STDIN</code>, taking come configuration parameters on the command-line.
From there, I used a <code>Port</code> in Elixir to &lsquo;safely&rsquo; talk to this C code without risking a catastrophic failure of the whole Erlang VM by loading the C code directly using the <code>NIF</code> method.</p>

<p>Here&rsquo;s how that looks.
Also note the use of <code>:code.priv_dir/1</code>, which takes the name of the specified Release and returns the file system path to the <code>priv/</code> directory within your packaged Application.</p>

<figure class='code'><figcaption><span>nerves_io_neopixel_driver.ex</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="k">defmodule</span> <span class="no">Nerves</span><span class="o">.</span><span class="no">IO</span><span class="o">.</span><span class="no">Neopixel</span><span class="o">.</span><span class="no">Driver</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'><span class="k">  </span><span class="kn">use</span> <span class="no">GenServer</span>
</span><span class='line'>  <span class="kn">require</span> <span class="no">Logger</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">start_link</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="k">    </span><span class="no">Logger</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="bp">__MODULE__</span><span class="si">}</span><span class="s2"> Starting&quot;</span>
</span><span class='line'>    <span class="no">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="bp">__MODULE__</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">init</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="k">    </span><span class="no">Logger</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="bp">__MODULE__</span><span class="si">}</span><span class="s2"> initializing: </span><span class="si">#{</span><span class="n">inspect</span> <span class="n">settings</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">pin</span>   <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="ss">:pin</span><span class="p">]</span>
</span><span class='line'>    <span class="n">count</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="ss">:count</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="ss">:code</span><span class="o">.</span><span class="n">priv_dir</span><span class="p">(</span><span class="ss">:nerves_io_neopixel</span><span class="p">)</span><span class="si">}</span><span class="s2">/rpi_ws281x </span><span class="si">#{</span><span class="n">pin</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">port</span> <span class="o">=</span> <span class="no">Port</span><span class="o">.</span><span class="n">open</span><span class="p">({</span><span class="ss">:spawn</span><span class="p">,</span> <span class="n">cmd</span><span class="p">},</span> <span class="p">[</span><span class="ss">:binary</span><span class="p">])</span>
</span><span class='line'>    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">port</span><span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">handle_call</span><span class="p">({</span><span class="ss">:render</span><span class="p">,</span> <span class="n">pixel_data</span><span class="p">},</span> <span class="n">_from</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="k">    </span><span class="no">Logger</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="bp">__MODULE__</span><span class="si">}</span><span class="s2"> rendering: </span><span class="si">#{</span><span class="n">inspect</span> <span class="n">pixel_data</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="no">Port</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">pixel_data</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span><span class="ss">:reply</span><span class="p">,</span> <span class="ss">:ok</span><span class="p">,</span> <span class="n">port</span><span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The other secret sauce was something I adapted from <a href="https://github.com/fhunleth/elixir_ale">Frank Hunleth&rsquo;s elixir_ale project</a>, which also uses some C code for low-level hardware interfacing.
In your <code>mix.exs</code>, you just have to define a special <code>Compile</code> task (mine is called <code>Ws281x</code>), then add it to the <code>compilers</code> list further down.</p>

<figure class='code'><figcaption><span>mix.exs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="k">defmodule</span> <span class="no">Mix</span><span class="o">.</span><span class="no">Tasks</span><span class="o">.</span><span class="no">Compile</span><span class="o">.</span><span class="no">Ws281x</span> <span class="k">do</span>
</span><span class='line'><span class="k">  def</span> <span class="n">run</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="k">    </span><span class="m">0</span> <span class="o">=</span> <span class="no">Mix</span><span class="o">.</span><span class="no">Shell</span><span class="o">.</span><span class="no">IO</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="s2">&quot;make priv/rpi_ws281x&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="no">Mix</span><span class="o">.</span><span class="no">Project</span><span class="o">.</span><span class="n">build_structure</span>
</span><span class='line'>    <span class="ss">:ok</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">defmodule</span> <span class="no">Nerves</span><span class="o">.</span><span class="no">IO</span><span class="o">.</span><span class="no">Neopixel</span><span class="o">.</span><span class="no">Mixfile</span> <span class="k">do</span>
</span><span class='line'><span class="k">  </span><span class="kn">use</span> <span class="no">Mix</span><span class="o">.</span><span class="no">Project</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">project</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="c1"># ...</span>
</span><span class='line'>    <span class="ss">compilers:</span> <span class="p">[</span><span class="ss">:Ws281x</span><span class="p">,</span> <span class="ss">:elixir</span><span class="p">,</span> <span class="ss">:app</span><span class="p">],</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This tells <code>mix</code> to shell-out to <code>make</code> to build <code>priv/rpi_ws281x</code>, which is the target of the C code I wrapped around the <code>rpi_ws281x</code> library.
The <code>priv</code> directory in your project folder ends up getting packaged into the Erlang Release that is burned into the SD card, and accessible using the <code>:code.priv_dir/1</code> function mentioned earlier.
Here is what I have in the <code>Makefile</code> to make that work:</p>

<figure class='code'><figcaption><span>Makefile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='makefile'><span class='line'><span class="cp">include $(NERVES_ROOT)/scripts/nerves-elixir.mk</span>
</span><span class='line'>
</span><span class='line'><span class="nf">priv/rpi_ws281x</span><span class="o">:</span> <span class="m">src/dma.c src/pwm.c src/ws2811.c src/main.c</span>
</span><span class='line'>  @mkdir -p priv
</span><span class='line'>  <span class="k">$(</span>CC<span class="k">)</span> <span class="k">$(</span>CFLAGS<span class="k">)</span> -o <span class="nv">$@</span> <span class="nv">$^</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Controlling NeoPixels from Elixir</h2>

<p>If you want to dive in and try running the code, download <a href="https://github.com/GregMefford/nerves_io_neopixel">the <code>nerves_io_neopixel</code> repository</a>:</p>

<figure class='code'><figcaption><span>bash</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">mkdir ~/projects</span>
</span><span class='line'><span class="go">cd ~/projects</span>
</span><span class='line'><span class="go">git clone git@github.com:GregMefford/nerves_io_neopixel.git</span>
</span><span class='line'><span class="go">cd nerves_io_neopixel</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, assuming that you checked out <code>nerves-system-br</code> to your home directory and did the <code>make</code> step earlier, you can <code>source</code> the environment script to set up the cross-compilers, then build the project.</p>

<figure class='code'><figcaption><span>bash</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">source ~/nerves-system-br/nerves-env.sh</span>
</span><span class='line'><span class="go">make</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you&rsquo;re doing this on a Linux VM with a Windows host, you also need to take one more step to generate the <code>.img</code> file that you need to burn to the SD card:</p>

<figure class='code'><figcaption><span>bash</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">fwup -a -i _images/nerves_io_neopixel.fw -d _images/nerves_io_neopixel.img -t complete</span>
</span></code></pre></td></tr></table></div></figure>


<p>This takes the efficiently-packed &ldquo;firmware&rdquo; file with a <code>.fw</code> extension and formats it into a much larger file with the appropriate blank-space offsets so that it can be booted on the target.</p>

<figure class='code'><figcaption><span>bash</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go"> 18M nerves_io_neopixel.fw</span>
</span><span class='line'><span class="go">329M nerves_io_neopixel.img</span>
</span></code></pre></td></tr></table></div></figure>


<p>From there, you can copy the <code>.img</code> file to the Windows host using WinSCP, burn it to an SD card using Win32DiskImager, and boot from it on the Raspberry Pi.</p>

<p><img class="center" src="http://www.gregmefford.com/images/posts/2016-01-22-driving-neopixels-with-elixir-and-nerves/winscp.png" title="Copying the img file with WinSCP" ></p>

<p><img class="center" src="http://www.gregmefford.com/images/posts/2016-01-22-driving-neopixels-with-elixir-and-nerves/win32diskimager.png" title="Burning the SD card with Win32DiskImager" ></p>

<p>Once the Pi boots, it loads <code>iex</code> but doesn&rsquo;t do anything with the LEDs.
To make something display, you have to <code>setup</code> which I/O pin to use and how many LEDs are chained together, then <code>render</code> something to them:</p>

<figure class='code'><figcaption><span>iex</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="no">Alias</span> <span class="no">Nerves</span><span class="o">.</span><span class="no">IO</span><span class="o">.</span><span class="no">Neopixel</span>
</span><span class='line'><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">pid</span><span class="p">}</span> <span class="o">=</span> <span class="no">Neopixel</span><span class="o">.</span><span class="n">setup</span> <span class="ss">pin:</span> <span class="m">18</span><span class="p">,</span> <span class="ss">count:</span> <span class="m">3</span>
</span><span class='line'><span class="no">Neopixel</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="m">255</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="o">&gt;&gt;</span> <span class="o">&lt;&gt;</span> <span class="o">&lt;&lt;</span><span class="m">0</span><span class="p">,</span> <span class="m">255</span><span class="p">,</span> <span class="m">0</span><span class="o">&gt;&gt;</span> <span class="o">&lt;&gt;</span> <span class="o">&lt;&lt;</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">255</span><span class="o">&gt;&gt;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="http://www.gregmefford.com/images/posts/2016-01-22-driving-neopixels-with-elixir-and-nerves/nerves_neopixel_rgb.jpg" title="Red, Green, and Blue NeoPixels" ></p>

<p>The second argument to the <code>render</code> function is a binary representing the RGB values of each LED.
I have just concatenated three 3-byte binaries here so it&rsquo;s easier to see where each LED&rsquo;s configuration begins and ends.
It&rsquo;s not pretty, and it would be tedious to do anything very complicated with just this interface, but it works!</p>

<p>To demonstrate something a bit more fun, I made a small demo to show how you might use the <code>Nerves.IO.Neopixel</code> library in a project.
The project implements a <code>scan</code> function that uses the <code>render</code> interface to draw a single red light sweeping back and forth across the strip, Battlestar Galactica style.
It initializes a strip with 72 LEDs (since I happened to have a half-meter strip of <a href="https://www.adafruit.com/products/1506">the 144-LED-per-meter variety</a>) and scans across them at 10 milliseconds per frame.</p>

<p>You can check out the code for the <a href="https://github.com/GregMefford/nerves_neopixel_examples/tree/master/apps/scanner"><code>scanner</code> app in my <code>nerves_neopixel_examples</code> repo on GitHub</a>.</p>

<p><img class="center" src="http://www.gregmefford.com/images/posts/2016-01-22-driving-neopixels-with-elixir-and-nerves/nerves_scanner.gif" title="Red Light Scanning Across the Strip" ></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Analyzing Cisco ASA Firewall Logs with Logstash]]></title>
    <link href="http://www.gregmefford.com/blog/2014/09/24/analyzing-cisco-asa-firewall-logs-with-logstash/"/>
    <updated>2014-09-24T22:32:01-04:00</updated>
    <id>http://www.gregmefford.com/blog/2014/09/24/analyzing-cisco-asa-firewall-logs-with-logstash</id>
    <content type="html"><![CDATA[<p>A year ago, I had a need to collect, analyze, and archive firewall logs from several Cisco ASA appliances.
The problem with Cisco&rsquo;s ASA syslog format is that each type of message is a special snowflake, apparently designed for human consumption rather than machine parsing.
The obvious solution was, of course, to use what is now know as <a href="http://www.elasticsearch.org/overview/">the ELK stack</a>: ElasticSearch, Logstash, and Kibana.
In this article, I&rsquo;ll walk through the process I used to tackle this problem, ending with a full configuration file that you can use in your environment.</p>

<!-- more -->


<h2>TL;DR</h2>

<p>If you&rsquo;re interested in the details about how this configuration was developed, read more below.
If you&rsquo;re just here for the final configuration file, here it is.
Unfortunately, there&rsquo;s not a <a href="http://pygments.org/">Pygments</a> lexer to provide syntax-highlighting for the Logstash config file format yet, but that&rsquo;s a <a href="http://en.wiktionary.org/wiki/yak_shaving">yak to be shaved</a> another day.</p>

<figure class='code'><figcaption><span>cisco-asa.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>input {
</span><span class='line'>  # Receive Cisco ASA logs on the standard syslog UDP port 514
</span><span class='line'>  udp {
</span><span class='line'>    port =&gt; 514
</span><span class='line'>    type =&gt; &quot;cisco-asa&quot;
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>filter {
</span><span class='line'>  if type == &quot;cisco-asa&quot; {
</span><span class='line'>    # Split the syslog part and Cisco tag out of the message
</span><span class='line'>    grok {
</span><span class='line'>      match =&gt; [&quot;message&quot;, &quot;%{CISCO_TAGGED_SYSLOG} %{GREEDYDATA:cisco_message}&quot;]
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    # Parse the syslog severity and facility
</span><span class='line'>    syslog_pri { }
</span><span class='line'>
</span><span class='line'>    # Parse the date from the &quot;timestamp&quot; field to the &quot;@timestamp&quot; field
</span><span class='line'>    date {
</span><span class='line'>      match =&gt; [&quot;timestamp&quot;,
</span><span class='line'>        &quot;MMM dd HH:mm:ss&quot;,
</span><span class='line'>        &quot;MMM  d HH:mm:ss&quot;,
</span><span class='line'>        &quot;MMM dd yyyy HH:mm:ss&quot;,
</span><span class='line'>        &quot;MMM  d yyyy HH:mm:ss&quot;
</span><span class='line'>      ]
</span><span class='line'>      timezone =&gt; &quot;America/New_York&quot;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    # Clean up redundant fields if parsing was successful
</span><span class='line'>    if &quot;_grokparsefailure&quot; not in [tags] {
</span><span class='line'>      mutate {
</span><span class='line'>        rename =&gt; [&quot;cisco_message&quot;, &quot;message&quot;]
</span><span class='line'>        remove_field =&gt; [&quot;timestamp&quot;]
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    # Extract fields from the each of the detailed message types
</span><span class='line'>    # The patterns provided below are included in Logstash since 1.2.0
</span><span class='line'>    grok {
</span><span class='line'>      match =&gt; [
</span><span class='line'>        &quot;message&quot;, &quot;%{CISCOFW106001}&quot;,
</span><span class='line'>        &quot;message&quot;, &quot;%{CISCOFW106006_106007_106010}&quot;,
</span><span class='line'>        &quot;message&quot;, &quot;%{CISCOFW106014}&quot;,
</span><span class='line'>        &quot;message&quot;, &quot;%{CISCOFW106015}&quot;,
</span><span class='line'>        &quot;message&quot;, &quot;%{CISCOFW106021}&quot;,
</span><span class='line'>        &quot;message&quot;, &quot;%{CISCOFW106023}&quot;,
</span><span class='line'>        &quot;message&quot;, &quot;%{CISCOFW106100}&quot;,
</span><span class='line'>        &quot;message&quot;, &quot;%{CISCOFW110002}&quot;,
</span><span class='line'>        &quot;message&quot;, &quot;%{CISCOFW302010}&quot;,
</span><span class='line'>        &quot;message&quot;, &quot;%{CISCOFW302013_302014_302015_302016}&quot;,
</span><span class='line'>        &quot;message&quot;, &quot;%{CISCOFW302020_302021}&quot;,
</span><span class='line'>        &quot;message&quot;, &quot;%{CISCOFW305011}&quot;,
</span><span class='line'>        &quot;message&quot;, &quot;%{CISCOFW313001_313004_313008}&quot;,
</span><span class='line'>        &quot;message&quot;, &quot;%{CISCOFW313005}&quot;,
</span><span class='line'>        &quot;message&quot;, &quot;%{CISCOFW402117}&quot;,
</span><span class='line'>        &quot;message&quot;, &quot;%{CISCOFW402119}&quot;,
</span><span class='line'>        &quot;message&quot;, &quot;%{CISCOFW419001}&quot;,
</span><span class='line'>        &quot;message&quot;, &quot;%{CISCOFW419002}&quot;,
</span><span class='line'>        &quot;message&quot;, &quot;%{CISCOFW500004}&quot;,
</span><span class='line'>        &quot;message&quot;, &quot;%{CISCOFW602303_602304}&quot;,
</span><span class='line'>        &quot;message&quot;, &quot;%{CISCOFW710001_710002_710003_710005_710006}&quot;,
</span><span class='line'>        &quot;message&quot;, &quot;%{CISCOFW713172}&quot;,
</span><span class='line'>        &quot;message&quot;, &quot;%{CISCOFW733100}&quot;
</span><span class='line'>      ]
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>output {
</span><span class='line'>  # Archive Cisco ASA firewall logs on disk based on the event&#39;s timestamp
</span><span class='line'>  # Results in directories for each year and month, with conveniently-named log files, like:
</span><span class='line'>  # /path/to/archive/cisco-asa/2014/2014-09/cisco-asa-2014-09-24.log
</span><span class='line'>  file {
</span><span class='line'>    path =&gt; &quot;/path/to/archive/%{type}/%{+YYYY}/%{+YYYY-MM}/%{type}-%{+YYYY-MM-dd}.log&quot;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  # Also output to ElasticSearch for review in Kibana
</span><span class='line'>  elasticsearch_http { host =&gt; &quot;elasticsearch-server-name&quot; }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<h2>Surely This is a Solved Problem</h2>

<p>After doing some Google searches, I found that several people were trying to do this with varying levels of success, but no one had yet documented even an 80% solution.
The best I could find was <a href="https://gist.github.com/dav3860/5345656">a gist by dav3860</a>, which gave me a great start on how to parse some of the <a href="http://www.cisco.com/en/US/docs/security/asa/syslog-guide/logmsgs.html">many, many Cisco ASA syslog message formats</a>.
Unfortunately, this gist didn&rsquo;t cover many of the message formats that I wanted to analyze from my environment and didn&rsquo;t capture all of the available data fields from the messages.
Seeing that there was demand for it on the mailing list and no one else seemed to have a good solution, I decided to figure it out myself and contribute the result back to the community.</p>

<h2>Stand Back, I Know Regular Expressions</h2>

<p>I started by collecting a large-ish sample of about half a million events from my production environment.
The ASA Device Manager (ASDM) software made this process pretty easy, if a bit tedious, by providing a file manager to download the log files from its internal Flash memory.
This allowed me to iteratively develop Grok expression against a known corpus of data.
When I hit an edge-case that failed to parse for some reason, I could tweak the expression and try again with the same input.</p>

<p>If you&rsquo;re here trying to figure out how to parse your Cisco ASA logs, you&rsquo;ve probably already seen what they look like.
In case you haven&rsquo;t, and for the sake of discussion, here&rsquo;s a little taste (obviously contrived and anonymized):</p>

<figure class='code'><figcaption><span>cisco-asa.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&lt;134&gt;Sep 02 2014 11:50:10: %ASA-6-302013: Built inbound TCP connection 123456789 for inside:10.0.1.1/1234 (10.0.1.1/1234) to outside:10.0.2.2/80 (10.0.2.2/80)
</span><span class='line'>&lt;134&gt;Sep 02 2014 11:50:10: %ASA-6-302014: Teardown TCP connection 123456789 for inside:10.0.1.1/1234 to outside:10.0.2.2/80 duration 0:00:00 bytes 420 TCP FINs
</span><span class='line'>&lt;134&gt;Sep 02 2014 11:50:15: %ASA-6-106015: Deny TCP (no connection) from 10.0.1.1/4567 to 10.0.3.3/80 flags FIN ACK  on interface inside
</span><span class='line'>&lt;163&gt;Sep 02 2014 11:50:25: %ASA-3-710003: TCP access denied by ACL from 10.0.4.4/6666 to outside:10.0.1.1/22
</span></code></pre></td></tr></table></div></figure>


<p>Just from peering dubiously at these logs for a minute, I was able to divine a few things:</p>

<ul>
<li>There&rsquo;s a &ldquo;standard&rdquo; syslog prefix at the beginning with a severity code and a timestamp.</li>
<li>The timestamp is in some random format, and it&rsquo;s in local time instead of UTC. ::sigh::</li>
<li>There&rsquo;s some kind of Cisco proprietary code at the beginning that I&rsquo;m going to call a <code>ciscotag</code> for want of a better name.</li>
<li>After the <code>ciscotag</code>, there&rsquo;s a human-readable message containing the meat and potatoes that we want to parse.</li>
</ul>


<p>With a little <a href="http://logstash.net/docs/latest/filters/grok">Grok-fu</a>, I was able to build the following patterns file to match the beginning part of the messages:</p>

<figure class='code'><figcaption><span>patterns/patterns.txt</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>CISCO_TAGGED_SYSLOG ^&lt;%{POSINT:syslog_pri}&gt;%{CISCOTIMESTAMP:timestamp}( %{SYSLOGHOST:sysloghost})?: %%{CISCOTAG:ciscotag}:
</span><span class='line'>CISCOTIMESTAMP %{MONTH} +%{MONTHDAY}(?: %{YEAR})? %{TIME}
</span><span class='line'>CISCOTAG [A-Z0-9]+-%{INT}-(?:[A-Z0-9_]+)
</span></code></pre></td></tr></table></div></figure>


<p>The keen-eyed reader will notice that these patterns don&rsquo;t match my logs identically.
For example, my logs don&rsquo;t have a <code>SYSLOGHOST</code>, and I have the <code>YEAR</code> marked as optional even though it&rsquo;s there in my logs.
Based on feedback from other people who tried to use my patterns, I learned that the ASA syslog output can vary based on firmware version and some config settings.
The awesome power of Grok patterns is that it&rsquo;s pretty easy to tweak them to work flexibly for everyone without making a tangled mess.</p>

<h2>Now We&rsquo;re Getting Somewhere</h2>

<p>At this point, we have enough to actually run the ELK stack to guide the rest of the development.
The following is a simple &ldquo;test fixture&rdquo; setup that I found useful during this process.
I&rsquo;m going to assume that you&rsquo;re trying to accomplish this task using a Windows machine, but it&rsquo;s pretty easy to tell how the same would work in Bash.
Let&rsquo;s be honest; there are too few tutorials that help people be productive with tools like this on Windows.</p>

<p>First, download <a href="https://download.elasticsearch.org/logstash/logstash/logstash-1.4.2.zip">the latest Logstash core zip file (currently 1.4.2)</a> and unpack it somewhere convenient.</p>

<p>Then create a configuration file called <code>logstash.conf</code> and a batch file called <code>run_logstash.bat</code> containing the following:</p>

<figure class='code'><figcaption><span>logstash.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>input {
</span><span class='line'>  stdin { }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>filter {
</span><span class='line'>  grok {
</span><span class='line'>    patterns_dir =&gt; &quot;.\patterns\&quot; # The directory containing the patterns file mentioned above
</span><span class='line'>    match =&gt; [&quot;message&quot;, &quot;%{CISCO_TAGGED_SYSLOG} %{GREEDYDATA:cisco_message}&quot;]
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  date {
</span><span class='line'>    match =&gt; [&quot;timestamp&quot;,
</span><span class='line'>      &quot;MMM dd HH:mm:ss&quot;,
</span><span class='line'>      &quot;MMM  d HH:mm:ss&quot;,
</span><span class='line'>      &quot;MMM dd yyyy HH:mm:ss&quot;,
</span><span class='line'>      &quot;MMM  d yyyy HH:mm:ss&quot;
</span><span class='line'>    ]
</span><span class='line'>    timezone =&gt; &quot;America/New_York&quot;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  syslog_pri { }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>output {
</span><span class='line'>  stdout { codec =&gt; &quot;rubydebug&quot; }
</span><span class='line'>  if &quot;_grokparsefailure&quot; in [tags] {
</span><span class='line'>    file {
</span><span class='line'>      path =&gt; &quot;./failure.json&quot;
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>  else {
</span><span class='line'>    file {
</span><span class='line'>      path =&gt; &quot;./success_%{ciscotag}.json&quot;
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>run_logstash.bat</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bat'><span class='line'>logstash<span class="m">-1</span>.<span class="m">4</span>.<span class="m">2</span>\bin\logstash.bat agent -f logstash.conf
</span></code></pre></td></tr></table></div></figure>


<p>When you execute <code>run_logstash.bat</code>, Logstash will fire up and wait for input on <code>STDIN</code>.
When you paste a set of events into the console, they will be processed and the results displayed on the screen as well as being appended to the specified files.</p>

<p>I had a big sample of event data that I had collected, so it resulted in a bunch of <code>success_&lt;something&gt;.json</code> files of varying sizes.
Each of these files contained the JSON-ified version of each event.
For example, the following would show up on the console, with the same being appended to the <code>success_ASA-3-710003.json</code> file (except on one line per event):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">{</span>
</span><span class='line'><span class="go">                 &quot;message&quot; =&gt; &quot;&lt;134&gt;Sep 02 2014 11:50:10: %ASA-6-302013: Built inbound TCP connection 123456789 for inside:10.0.1.1/1234 (10.0.1.1/1234) to outside:10.0.2.2/80 (10.0.2.2/80)\r&quot;,</span>
</span><span class='line'><span class="go">                &quot;@version&quot; =&gt; &quot;1&quot;,</span>
</span><span class='line'><span class="go">              &quot;@timestamp&quot; =&gt; &quot;2014-09-02T15:50:10.000Z&quot;,</span>
</span><span class='line'><span class="go">                    &quot;host&quot; =&gt; &quot;Forklift&quot;,</span>
</span><span class='line'><span class="go">              &quot;syslog_pri&quot; =&gt; &quot;134&quot;,</span>
</span><span class='line'><span class="go">               &quot;timestamp&quot; =&gt; &quot;Sep 02 2014 11:50:10&quot;,</span>
</span><span class='line'><span class="go">                &quot;ciscotag&quot; =&gt; &quot;ASA-6-302013&quot;,</span>
</span><span class='line'><span class="go">           &quot;cisco_message&quot; =&gt; &quot;Built inbound TCP connection 123456789 for inside:10.0.1.1/1234 (10.0.1.1/1234) to outside:10.0.2.2/80 (10.0.2.2/80)\r&quot;,</span>
</span><span class='line'><span class="go">    &quot;syslog_severity_code&quot; =&gt; 6,</span>
</span><span class='line'><span class="go">    &quot;syslog_facility_code&quot; =&gt; 16,</span>
</span><span class='line'><span class="go">         &quot;syslog_facility&quot; =&gt; &quot;local0&quot;,</span>
</span><span class='line'><span class="go">         &quot;syslog_severity&quot; =&gt; &quot;informational&quot;</span>
</span><span class='line'><span class="go">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Looking at the relative sizes of the resulting files, I could make inferences about the log volume of each type, allowing me to prioritize which patterns to focus on first.
The <code>ASA-6-302013</code> event is logged whenever a connection is successfully established across the firewall, so that tends to be pretty frequent.
By adding the following Grok filter to the filter list, I was able to easily parse out all of the relevant fields:</p>

<figure class='code'><figcaption><span>logstash.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># ...
</span><span class='line'>filter {
</span><span class='line'>  # ...
</span><span class='line'>
</span><span class='line'>  syslog_pri { }
</span><span class='line'>
</span><span class='line'>  grok {
</span><span class='line'>    match =&gt; [
</span><span class='line'>      &quot;cisco_message&quot;,
</span><span class='line'>      &quot;Built inbound TCP connection %{INT:connection_id} for %{DATA:src_interface}:%{IP:src_ip}/%{INT:src_port}( \(%{IP:src_mapped_ip}/%{INT:src_mapped_port}\))? to %{DATA:dst_interface}:%{IP:dst_ip}/%{INT:dst_port}( \(%{IP:dst_mapped_ip}/%{INT:dst_mapped_port}\))?&quot;
</span><span class='line'>    ]
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'># ...
</span></code></pre></td></tr></table></div></figure>


<p>Which results in the following magical output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">{</span>
</span><span class='line'><span class="go">                 &quot;message&quot; =&gt; &quot;&lt;134&gt;Sep 02 2014 11:50:10: %ASA-6-302013: Built inbound TCP connection 123456789 for inside:10.0.1.1/1234 (10.0.1.1/1234) to outside:10.0.2.2/80 (10.0.2.2/80)\r&quot;,</span>
</span><span class='line'><span class="go">                &quot;@version&quot; =&gt; &quot;1&quot;,</span>
</span><span class='line'><span class="go">              &quot;@timestamp&quot; =&gt; &quot;2014-09-02T15:50:10.000Z&quot;,</span>
</span><span class='line'><span class="go">                    &quot;host&quot; =&gt; &quot;Forklift&quot;,</span>
</span><span class='line'><span class="go">              &quot;syslog_pri&quot; =&gt; &quot;134&quot;,</span>
</span><span class='line'><span class="go">               &quot;timestamp&quot; =&gt; &quot;Sep 02 2014 11:50:10&quot;,</span>
</span><span class='line'><span class="go">                &quot;ciscotag&quot; =&gt; &quot;ASA-6-302013&quot;,</span>
</span><span class='line'><span class="go">           &quot;cisco_message&quot; =&gt; &quot;Built inbound TCP connection 123456789 for inside:10.0.1.1/1234 (10.0.1.1/1234) to outside:10.0.2.2/80 (10.0.2.2/80)\r&quot;,</span>
</span><span class='line'><span class="go">    &quot;syslog_severity_code&quot; =&gt; 6,</span>
</span><span class='line'><span class="go">    &quot;syslog_facility_code&quot; =&gt; 16,</span>
</span><span class='line'><span class="go">         &quot;syslog_facility&quot; =&gt; &quot;local0&quot;,</span>
</span><span class='line'><span class="go">         &quot;syslog_severity&quot; =&gt; &quot;informational&quot;,</span>
</span><span class='line'><span class="go">           &quot;connection_id&quot; =&gt; &quot;123456789&quot;,</span>
</span><span class='line'><span class="go">           &quot;src_interface&quot; =&gt; &quot;inside&quot;,</span>
</span><span class='line'><span class="go">                  &quot;src_ip&quot; =&gt; &quot;10.0.1.1&quot;,</span>
</span><span class='line'><span class="go">                &quot;src_port&quot; =&gt; &quot;1234&quot;,</span>
</span><span class='line'><span class="go">           &quot;src_mapped_ip&quot; =&gt; &quot;10.0.1.1&quot;,</span>
</span><span class='line'><span class="go">         &quot;src_mapped_port&quot; =&gt; &quot;1234&quot;,</span>
</span><span class='line'><span class="go">           &quot;dst_interface&quot; =&gt; &quot;outside&quot;,</span>
</span><span class='line'><span class="go">                  &quot;dst_ip&quot; =&gt; &quot;10.0.2.2&quot;,</span>
</span><span class='line'><span class="go">                &quot;dst_port&quot; =&gt; &quot;80&quot;,</span>
</span><span class='line'><span class="go">           &quot;dst_mapped_ip&quot; =&gt; &quot;10.0.2.2&quot;,</span>
</span><span class='line'><span class="go">         &quot;dst_mapped_port&quot; =&gt; &quot;80&quot;</span>
</span><span class='line'><span class="go">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>After figuring out several such Grok patterns and consulting with the documentation, I discovered that many of the formats are pretty similar to one another.
For those, I broke out the common fragments from each message and combined the similar Grok expressions into a pattern file.
The format of the pattern file is the same as what would go in the <code>match</code> clause of the <code>grok</code> filter, except with an <code>ALL_CAPS_NAME</code> at the beginning of each line.</p>

<p>Here&rsquo;s a snippet of the resulting patterns file in all its complex glory, but only for the demo messages we&rsquo;re discussing here.
These patterns and a bunch more are already included in Logstash, so you won&rsquo;t need to include them in your own pattern files.
The power of Grok is that, though these patterns can get pretty hairy, they&rsquo;re reasonably understandable.
The fully-expanded regular expressions they represent are simply asburd and would be nearly impossible to change or maintain.</p>

<figure class='code'><figcaption><span>patterns/patterns.txt</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>#== Cisco ASA ==
</span><span class='line'>CISCO_TAGGED_SYSLOG ^&lt;%{POSINT:syslog_pri}&gt;%{CISCOTIMESTAMP:timestamp}( %{SYSLOGHOST:sysloghost})?: %%{CISCOTAG:ciscotag}:
</span><span class='line'>CISCOTIMESTAMP %{MONTH} +%{MONTHDAY}(?: %{YEAR})? %{TIME}
</span><span class='line'>CISCOTAG [A-Z0-9]+-%{INT}-(?:[A-Z0-9_]+)
</span><span class='line'>
</span><span class='line'># Common Particles
</span><span class='line'>CISCO_ACTION Built|Teardown|Deny|Denied|denied|requested|permitted|denied by ACL|discarded|est-allowed|Dropping|created|deleted
</span><span class='line'>CISCO_REASON Duplicate TCP SYN|Failed to locate egress interface|Invalid transport field|No matching connection|DNS Response|DNS Query|(?:%{WORD}\s*)*
</span><span class='line'>CISCO_DIRECTION Inbound|inbound|Outbound|outbound
</span><span class='line'>
</span><span class='line'># ASA-6-106015
</span><span class='line'>CISCOFW106015 %{CISCO_ACTION:action} %{WORD:protocol} \(%{DATA:policy_id}\) from %{IP:src_ip}/%{INT:src_port} to %{IP:dst_ip}/%{INT:dst_port} flags %{DATA:tcp_flags}  on interface %{GREEDYDATA:interface}
</span><span class='line'>
</span><span class='line'># ASA-6-302013, ASA-6-302014, ASA-6-302015, ASA-6-302016
</span><span class='line'>CISCOFW302013_302014_302015_302016 %{CISCO_ACTION:action}(?: %{CISCO_DIRECTION:direction})? %{WORD:protocol} connection %{INT:connection_id} for %{DATA:src_interface}:%{IP:src_ip}/%{INT:src_port}( \(%{IP:src_mapped_ip}/%{INT:src_mapped_port}\))?(\(%{DATA:src_fwuser}\))? to %{DATA:dst_interface}:%{IP:dst_ip}/%{INT:dst_port}( \(%{IP:dst_mapped_ip}/%{INT:dst_mapped_port}\))?(\(%{DATA:dst_fwuser}\))?( duration %{TIME:duration} bytes %{INT:bytes})?(?: %{CISCO_REASON:reason})?( \(%{DATA:user}\))?
</span><span class='line'>
</span><span class='line'># ASA-7-710001, ASA-7-710002, ASA-7-710003, ASA-7-710005, ASA-7-710006
</span><span class='line'>CISCOFW710001_710002_710003_710005_710006 %{WORD:protocol} (?:request|access) %{CISCO_ACTION:action} from %{IP:src_ip}/%{INT:src_port} to %{DATA:dst_interface}:%{IP:dst_ip}/%{INT:dst_port}
</span><span class='line'>
</span><span class='line'>#== End Cisco ASA ==
</span></code></pre></td></tr></table></div></figure>


<p>Now we can use the pattern file to extract the complexity from the <code>logstash.conf</code> configuration file.
The previous configuration snippet can now be replaced by this one:</p>

<figure class='code'><figcaption><span>logstash.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># ...
</span><span class='line'>filter {
</span><span class='line'>  # ...
</span><span class='line'>
</span><span class='line'>  syslog_pri { }
</span><span class='line'>
</span><span class='line'>  grok {
</span><span class='line'>    patterns_dir =&gt; &quot;./patterns/&quot;
</span><span class='line'>    match =&gt; [
</span><span class='line'>      &quot;cisco_message&quot;, &quot;%{CISCOFW106015}&quot;,
</span><span class='line'>      &quot;cisco_message&quot;, &quot;%{CISCOFW302013_302014_302015_302016}&quot;,
</span><span class='line'>      &quot;cisco_message&quot;, &quot;%{CISCOFW710001_710002_710003_710005_710006}&quot;,
</span><span class='line'>    ]
</span><span class='line'>  }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>This results in the same output as above, only now the Grok filter will try to match against each of the requested patterns until one of them succeeds.</p>

<p>From this point, it just took additional slogging through the various event formats, documentation, and real-world example data until I had most of what I wanted.
If you&rsquo;re curious about what message formats are available in the Logstash distribution today, <a href="https://github.com/elasticsearch/logstash/blob/master/patterns/firewalls">this</a> source file contains them.</p>

<p>I have tried to consolidate the field names that are parsed out of the messages to make the Kibana dashboard-creation process more straightforward.
For example, if a message is talking about the disposition of a connection in some way, I parse that out as the <code>action</code> field even though the Cisco documentation doesn&rsquo;t call it an &ldquo;action.&rdquo;
This allows you to easily create a Kibana dashboard showing a table or graph summarizing the values of the <code>action</code> field, like <code>denied</code>, <code>permitted</code>, or <code>discarded</code>.</p>

<h2>Cleaning Up</h2>

<p>What&rsquo;s still missing is the final polish.
You may notice that there are some redundant fields that are going to end up wasting space in the database where these events will ultimately live.
For example, <code>timestamp</code> and <code>@timestamp</code> contain the same information expressed two different ways.
<code>timestamp</code> is the Cisco format that was parsed out of the message, and <code>@timestamp</code> is Logstash&rsquo;s internal representation in ISO8601 format that results from the <code>date</code> filter.
Also, the <code>message</code> field becomes redundant once it has been parsed into its constituent parts.
I find that, while we don&rsquo;t need to keep both <code>message</code> and <code>cisco_message</code>, it is worth keeping the content of the smaller <code>cisco_message</code> field rather than just the constituent fields.
This allows easier troubleshooting of the Grok parsing if there&rsquo;s a strange edge-case or dumping out the full text of the log lines to a file to show someone outside of Kibana.</p>

<p>We can very easily strip out the redundant fields, making sure to only truncate data that was successfully parsed, using a <code>mutate</code> filter:</p>

<figure class='code'><figcaption><span>logstash.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># ...
</span><span class='line'>
</span><span class='line'>filter {
</span><span class='line'>  # ...
</span><span class='line'>
</span><span class='line'>  # Clean up redundant fields if parsing was successful
</span><span class='line'>  if &quot;_grokparsefailure&quot; not in [tags] {
</span><span class='line'>    mutate {
</span><span class='line'>      rename =&gt; [&quot;cisco_message&quot;, &quot;message&quot;]
</span><span class='line'>      remove_field =&gt; [&quot;timestamp&quot;]
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  # ...
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'># ...
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s also a good idea to design the pieces of your Logstash configuration to play nicely with each other as you add more log sources and destinations.
One common way to do this is the apply a <code>type</code> to the event at the input, then process it accordingly using conditionals, like so:</p>

<figure class='code'><figcaption><span>logstash.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>input {
</span><span class='line'>  # Receive Cisco ASA logs on the standard syslog UDP port 514
</span><span class='line'>  udp {
</span><span class='line'>    port =&gt; 514
</span><span class='line'>    type =&gt; &quot;cisco-asa&quot;
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>filter {
</span><span class='line'>  if type == &quot;cisco-asa&quot; {
</span><span class='line'>    # Put your ASA-specific Grok, Date, and Mutate filters here
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>output {
</span><span class='line'>  # Archive Cisco ASA firewall logs on disk based on the event&#39;s timestamp
</span><span class='line'>  # Results in directories for each year and month, with conveniently-named log files, like:
</span><span class='line'>  # /path/to/archive/cisco-asa/2014/2014-09/cisco-asa-2014-09-24.log
</span><span class='line'>  file {
</span><span class='line'>    path =&gt; &quot;/path/to/archive/%{type}/%{+YYYY}/%{+YYYY-MM}/%{type}-%{+YYYY-MM-dd}.log&quot;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  # Also output to ElasticSearch for review in Kibana
</span><span class='line'>  elasticsearch_http { host =&gt; &quot;elasticsearch-server-name&quot; }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>Putting all the pieces together, you get the configuration listed in the TL;DR section at the top of the post!
The result is that you have taken &ldquo;human-readable&rdquo; logs from your firewall, transformed them into what&rsquo;s known as &ldquo;structured&rdquo; logs, and stored them for later review.</p>

<p>In my next post, I will show how that review process might look by going through the steps to create exploratory dashboards in Kibana.
Stay tuned!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Review: The Passionate Programmer]]></title>
    <link href="http://www.gregmefford.com/blog/2011/02/06/review-the-passionate-programmer/"/>
    <updated>2011-02-06T22:31:00-05:00</updated>
    <id>http://www.gregmefford.com/blog/2011/02/06/review-the-passionate-programmer</id>
    <content type="html"><![CDATA[<p>This afternoon, I finished <a href="http://twitter.com/chadfowler">@chadfowler</a>&rsquo;s <a href="http://amzn.com/1934356344"><a href="http://amzn.com/1934356344">The Passionate Programmer</a>.
One of my favorite books is <a href="http://amzn.com/020161622X">The Pragmatic Programmer</a>, so the similar title of this book (and the author, who I follow on <a href="http://twitter.com/ferggo">Twitter</a>) caught my eye.
I read a lot of hype about it leading up to its release and I was not disappointed!
Besides echoing <a href="http://illusional-mind.blogspot.com/2011/02/chad-fowler-passionate-programmer.html">many</a> <a href="http://elegantcode.com/2009/11/29/review-the-passionate-programmer/">other</a> <a href="http://vodra.wordpress.com/2011/01/11/book-review-the-passionate-programmer-by-chad-fowler/">reviewers&#8217;</a> <a href="http://suhinini.blogspot.com/2010/01/book-review-passionate-programmer-by.html">exhortation</a> to go pick up the book and read it if you care about your career, I thought it would be valuable to capture in text some of my thoughts, gathered while reading this book.</p>

<!-- more -->


<h2>Why You Should Read This Book</h2>

<p>The reason I ordered this book in the first place is that I am passionate about software development and about making the most of my career in technology.
This book is both inspirational and pragmatic (as the name of the publisher would imply).
Each chapter is a bite-sized discussion of a single aspect of improving yourself as a contributing member of the industry.
At the end of each chapter, there is an &ldquo;Act On It!&rdquo; section that gives some concrete things I can think about or do today to be better at what I do.
If you really care about what you do, read this book.
Even if what you do isn&rsquo;t software development, there is a lot of value here for everyone.</p>

<h2>What I Got Out of It</h2>

<h3>Things I was already doing that were validated:</h3>

<ul>
<li>Participating in Open Source (Reading others&#8217; code and contributing my own)</li>
<li>Striving to only work 40 hours per week</li>
<li>Practicing my craft outside of business hours</li>
<li>Exploring the bleeding edge of tomorrow&rsquo;s hot technologies</li>
</ul>


<h3>Things I immediately started doing after reading about them:</h3>

<ul>
<li>Learning more about how the business really works (what impacts the bottom-line?)</li>
<li>Practice writing more (here I am writing a blog post after far too long)</li>
<li>Recording commitments and tracking them to completion</li>
</ul>


<h3>Things I have been putting off that I&rsquo;m going to really start doing</h3>

<ul>
<li>Learn by teaching</li>
<li>&ldquo;Be the worst&rdquo; by striving to work with the best</li>
<li>Go deeper into understanding the technologies I use</li>
<li>Use this blog as a capture-point for research to remind my future self</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Signal Processing with R]]></title>
    <link href="http://www.gregmefford.com/blog/2010/06/25/signal-processing-with-r/"/>
    <updated>2010-06-25T14:40:39-04:00</updated>
    <id>http://www.gregmefford.com/blog/2010/06/25/signal-processing-with-r</id>
    <content type="html"><![CDATA[<p>I have been meaning to check out <a href="http://www.r-project.org/">R</a> for a few years now, but I got busy and I just never got around to doing much more than installing the MacOS X version on my laptop.
I finally got my excuse to try it when I needed to start working on signal processing of the measurements I had been gathering.
My usual go-to tool for this type of task was <a href="http://www.mathworks.com/">MATLAB</a>.
However, on this fateful day, when I tried to launch my copy of MATLAB, I got some kind of message saying that I needed to renew my license.
At some point in the past, I had bought a one-year student edition of MATLAB, so this wasn&rsquo;t a huge surprise.
However, that message was all it took to get me to finally check out R.</p>

<!-- more -->


<h2>What is R?</h2>

<p>Despite its rather silly name, R is a phenominal piece of software for analyzing data and generating high-quality charts and graphs.
It has a great user community, extensions to support just about any kind of data analysis you can think of, and best of all, it&rsquo;s free (as in &ldquo;free beer&rdquo; as well as &ldquo;free speech&rdquo;).
R offers a variety of functions for statistical analysis and signal processing of large data sets.</p>

<h2>Problem Description</h2>

<p>The data set to be analyzed is a set of measurements from an oscilloscope.
Each measurement represents a trace of the same analog signal, but they are not time-aligned and each has a considerable amount of noise.
The goal of this experiment is to time-align these data samples and perform some statistical analysis on them to pull some kind of signal out of the noise.</p>

<h2>Loading the Data</h2>

<p>The first task in any data-processing pipeline is the mundane step of importing the raw data from the data source into the data processing tool.
In this case, the data source is the Agilent oscilloscope being used to gather the measurements by converting the continuous-time analog signal of interest into a series of digital samples with 8 bits of resolution.
The wave forms are saved in &ldquo;segmented time&rdquo; mode so that multiple traces can be acquired in the oscilloscope before performing the alignment and statistical analysis.
These segmented time acquisitions are saved as a tab-delimited file with a tabular structure.
Each column of data represents a memory segment, which is a single trace.
Each trace consists of approximately 25,000 samples, stored as rows in the data file.</p>

<p>To load this type of data file into R and convert a trace into a time series for plotting and manipulation, the process is very straightforward:</p>

<figure class='code'><figcaption><span>Reading a CSV file</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>traces <span class="o">&lt;-</span> read.table<span class="p">(</span><span class="s">&quot;16traces.txt&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>It took me a while to figure out how to set up the margins on the plot, but it turns out to be simple once you find the proper command to set the graphics defaults.
<code>mar(bottom, left, top, right)</code> sets the margins around the plot, and <code>mgp(title, x, y)</code> sets the margin lines for the title and axes.</p>

<figure class='code'><figcaption><span>Formatting and Plotting a Time Series</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>par<span class="p">(</span>mar<span class="o">=</span>c<span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> mgp<span class="o">=</span>c<span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span> xaxt<span class="o">=</span><span class="s">&quot;n&quot;</span><span class="p">,</span> yaxt<span class="o">=</span><span class="s">&quot;n&quot;</span><span class="p">)</span>
</span><span class='line'>plot<span class="p">(</span>timeseries<span class="p">,</span> main<span class="o">=</span><span class="s">&quot;Single Raw Trace&quot;</span><span class="p">,</span> xlab<span class="o">=</span><span class="s">&quot;Time&quot;</span><span class="p">,</span> ylab<span class="o">=</span><span class="s">&quot;Current&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Plotting to a PNG image is also possible, with the result following:</p>

<figure class='code'><figcaption><span>Plotting to a PNG Image File</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>png<span class="p">(</span><span class="s">&quot;single_raw_trace.png&quot;</span><span class="p">,</span> width<span class="o">=</span><span class="m">600</span><span class="p">,</span> height<span class="o">=</span><span class="m">200</span><span class="p">)</span>
</span><span class='line'>  par<span class="p">(</span>mar<span class="o">=</span>c<span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> mgp<span class="o">=</span>c<span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span> xaxt<span class="o">=</span><span class="s">&quot;n&quot;</span><span class="p">,</span> yaxt<span class="o">=</span><span class="s">&quot;n&quot;</span><span class="p">)</span>
</span><span class='line'>  plot<span class="p">(</span>timeseries<span class="p">,</span> main<span class="o">=</span><span class="s">&quot;Single Raw Trace&quot;</span><span class="p">,</span> xlab<span class="o">=</span><span class="s">&quot;Time&quot;</span><span class="p">,</span> ylab<span class="o">=</span><span class="s">&quot;Current&quot;</span><span class="p">)</span>
</span><span class='line'>dev.off<span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="http://www.gregmefford.com/images/posts/2010-06-25-signal-processing-with-r/single_raw_trace.png" title="A single time-series measurement" ></p>

<h2>Simplifying the Data</h2>

<p>Now that we have the basics laid out, onward to some real work.</p>

<p>The first step needed to process the measurements is to smooth out the data to allow the lower-frequency features to be more visible.
To do this, I am going to use R&rsquo;s <code>lowess</code> function.
The best way to describe what this does is with an example:</p>

<figure class='code'><figcaption><span>Demonstrating Lowess Smoothing</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>png<span class="p">(</span><span class="s">&quot;lowess_smoothing.png&quot;</span><span class="p">,</span> width<span class="o">=</span><span class="m">600</span><span class="p">,</span> height<span class="o">=</span><span class="m">200</span><span class="p">)</span>
</span><span class='line'>  par<span class="p">(</span>mar<span class="o">=</span>c<span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> mgp<span class="o">=</span>c<span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span> xaxt<span class="o">=</span><span class="s">&quot;n&quot;</span><span class="p">,</span> yaxt<span class="o">=</span><span class="s">&quot;n&quot;</span><span class="p">)</span>
</span><span class='line'>  plot<span class="p">(</span>timeseries<span class="p">,</span> col<span class="o">=</span><span class="s">&quot;grey&quot;</span><span class="p">,</span>
</span><span class='line'>    main<span class="o">=</span><span class="s">&quot;Lowess Smoothing&quot;</span><span class="p">,</span> xlab<span class="o">=</span><span class="s">&quot;Time&quot;</span><span class="p">,</span> ylab<span class="o">=</span><span class="s">&quot;Current&quot;</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>  lines<span class="p">(</span>lowess<span class="p">(</span>timeseries<span class="p">,</span> f<span class="o">=</span><span class="m">.07</span><span class="p">))</span>
</span><span class='line'>dev.off<span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="http://www.gregmefford.com/images/posts/2010-06-25-signal-processing-with-r/lowess_smoothing.png" title="Lowess Smoothing" ></p>

<h2>Alignment</h2>

<p>The next step is pure magic.</p>

<p>What we need to do is align each measurement trace collected so that corresponding features can be compared and analyzed.
The plan is to use R&rsquo;s <code>ccf</code> function, which plots the correlation between two functions vs. the lag between them.</p>

<figure class='code'><figcaption><span>Correlating Two Traces while Varying the Lag Between Signals</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>ts1.low <span class="o">=</span> lowess<span class="p">(</span>ts<span class="p">(</span>traces<span class="p">[</span><span class="o">&lt;</span>sup class<span class="o">=</span><span class="s">&quot;footnote&quot;</span><span class="o">&gt;&lt;</span>a href<span class="o">=</span><span class="s">&quot;#fn1&quot;</span><span class="o">&gt;</span><span class="m">1</span><span class="o">&lt;/</span>a<span class="o">&gt;&lt;/</span>sup<span class="o">&gt;</span><span class="p">]),</span> f<span class="o">=</span><span class="m">.07</span><span class="p">)</span>
</span><span class='line'>ts5.low <span class="o">=</span> lowess<span class="p">(</span>ts<span class="p">(</span>traces<span class="p">[</span><span class="o">&lt;</span>sup class<span class="o">=</span><span class="s">&quot;footnote&quot;</span><span class="o">&gt;&lt;</span>a href<span class="o">=</span><span class="s">&quot;#fn5&quot;</span><span class="o">&gt;</span><span class="m">5</span><span class="o">&lt;/</span>a<span class="o">&gt;&lt;/</span>sup<span class="o">&gt;</span><span class="p">]),</span> f<span class="o">=</span><span class="m">.07</span><span class="p">)</span>
</span><span class='line'>png<span class="p">(</span><span class="s">&quot;correlation_t1_t5.png&quot;</span><span class="p">,</span> width<span class="o">=</span><span class="m">600</span><span class="p">,</span> height<span class="o">=</span><span class="m">400</span><span class="p">)</span>
</span><span class='line'>  par<span class="p">(</span>mar<span class="o">=</span>c<span class="p">(</span><span class="m">4</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> mgp<span class="o">=</span>c<span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">))</span>
</span><span class='line'>  plot<span class="p">(</span>
</span><span class='line'>    ccf<span class="p">(</span>ts1.low<span class="o">$</span>y<span class="p">,</span> ts5.low<span class="o">$</span>y<span class="p">,</span> lag.max<span class="o">=</span>length<span class="p">(</span>ts1<span class="p">)</span><span class="o">/</span><span class="m">2</span><span class="p">),</span>
</span><span class='line'>    main<span class="o">=</span><span class="s">&quot;Correlation: Trace 1 vs Trace 5&quot;</span><span class="p">,</span> xlab<span class="o">=</span><span class="s">&quot;Lag&quot;</span><span class="p">,</span> ylab<span class="o">=</span><span class="s">&quot;Correlation&quot;</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>dev.off<span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="http://www.gregmefford.com/images/posts/2010-06-25-signal-processing-with-r/correlation_t1_t5.png" title="Correlation: Trace 1 vs Trace 5" ></p>

<p>This plot is neat to look at, but what we really want is to find the absolute maximum of this function, which represents the offset that will cause the two traces to be aligned as well as possible.</p>

<figure class='code'><figcaption><span>Finding the Lag Value that Maximizes Correlation</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>  results <span class="o">=</span> ccf<span class="p">(</span>ts1.low<span class="o">$</span>y<span class="p">,</span> ts5.low<span class="o">$</span>y<span class="p">,</span> lag.max<span class="o">=</span>length<span class="p">(</span>ts1<span class="p">)</span><span class="o">/</span><span class="m">2</span><span class="p">)</span>
</span><span class='line'>  results<span class="o">$</span>lag<span class="p">[</span>which.max<span class="p">(</span>results<span class="o">$</span>acf<span class="p">)]</span>
</span></code></pre></td></tr></table></div></figure>


<p>The preceding code returns <code>536</code> for the data shown here, which passes the &ldquo;sniff-test&rdquo; according to the plot of the <code>ccf</code> function shown in the previous section.</p>

<p>If we lag the second plot using this amount, they should line up:</p>

<figure class='code'><figcaption><span>Plotting the Two Traces Using the Maximum-Correlation Lag Value</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>png<span class="p">(</span><span class="s">&quot;auto-aligned_traces.png&quot;</span><span class="p">,</span> width<span class="o">=</span><span class="m">600</span><span class="p">,</span> height<span class="o">=</span><span class="m">400</span><span class="p">)</span>
</span><span class='line'>  par<span class="p">(</span>mar<span class="o">=</span>c<span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> mgp<span class="o">=</span>c<span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span> xaxt<span class="o">=</span><span class="s">&quot;n&quot;</span><span class="p">,</span> yaxt<span class="o">=</span><span class="s">&quot;n&quot;</span><span class="p">)</span>
</span><span class='line'>  best_lag <span class="o">=</span> results<span class="o">$</span>lag<span class="p">[</span>which.max<span class="p">(</span>results<span class="o">$</span>acf<span class="p">)]</span>
</span><span class='line'>  ts1.lagged.low <span class="o">=</span> lowess<span class="p">(</span>lag<span class="p">(</span>ts1<span class="p">,</span> best_lag<span class="p">),</span> f<span class="o">=</span><span class="m">.07</span><span class="p">)</span>
</span><span class='line'>  plot<span class="p">(</span>ts1.lagged.low<span class="p">,</span> col<span class="o">=</span><span class="s">&quot;grey&quot;</span><span class="p">,</span>
</span><span class='line'>    main<span class="o">=</span><span class="s">&quot;Auto-Aligned Traces&quot;</span><span class="p">,</span> xlab<span class="o">=</span><span class="s">&quot;Time&quot;</span><span class="p">,</span> ylab<span class="o">=</span><span class="s">&quot;Current&quot;</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>  lines<span class="p">(</span>ts5.low<span class="p">)</span>
</span><span class='line'>dev.off<span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="http://www.gregmefford.com/images/posts/2010-06-25-signal-processing-with-r/auto-aligned_traces.png" title="Auto-Aligned Traces" ></p>

<p>This code starts to get pretty ugly, but the resulting figure shows just how nicely-aligned these features are, using a more fine-grained smoothing function to show a bit more detail:</p>

<figure class='code'><figcaption><span>Plotting the Aligned Traces with Less Smoothing</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='r'><span class='line'>png<span class="p">(</span><span class="s">&quot;hires_aligned_traces.png&quot;</span><span class="p">,</span> width<span class="o">=</span><span class="m">600</span><span class="p">,</span> height<span class="o">=</span><span class="m">200</span><span class="p">)</span>
</span><span class='line'>  par<span class="p">(</span>mar<span class="o">=</span>c<span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> mgp<span class="o">=</span>c<span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span> xaxt<span class="o">=</span><span class="s">&quot;n&quot;</span><span class="p">,</span> yaxt<span class="o">=</span><span class="s">&quot;n&quot;</span><span class="p">)</span>
</span><span class='line'>  ts1.low <span class="o">=</span> lowess<span class="p">(</span>ts1<span class="p">,</span> delta<span class="o">=</span><span class="m">10</span><span class="p">,</span> f<span class="o">=</span><span class="m">.01</span><span class="p">)</span>
</span><span class='line'>  ts5.low <span class="o">=</span> lowess<span class="p">(</span>ts5<span class="p">,</span> delta<span class="o">=</span><span class="m">10</span><span class="p">,</span> f<span class="o">=</span><span class="m">.01</span><span class="p">)</span>
</span><span class='line'>  ts1.aligned <span class="o">=</span> ts<span class="p">(</span>ts1.low<span class="o">$</span>y<span class="p">[</span>best_lag<span class="o">:</span>length<span class="p">(</span>ts1.lagged.low<span class="o">$</span>y<span class="p">)])</span>
</span><span class='line'>  ts5.aligned <span class="o">=</span> ts<span class="p">(</span>ts5.low<span class="o">$</span>y<span class="p">)</span>
</span><span class='line'>  plot<span class="p">(</span>ts1.aligned<span class="p">,</span> col<span class="o">=</span><span class="s">&quot;grey&quot;</span><span class="p">,</span>
</span><span class='line'>    main<span class="o">=</span><span class="s">&quot;High-Resolution Auto-Aligned Traces&quot;</span><span class="p">,</span> xlab<span class="o">=</span><span class="s">&quot;Time&quot;</span><span class="p">,</span> ylab<span class="o">=</span><span class="s">&quot;Current&quot;</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>  lines<span class="p">(</span>ts5.aligned<span class="p">)</span>
</span><span class='line'>dev.off<span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="http://www.gregmefford.com/images/posts/2010-06-25-signal-processing-with-r/hires_aligned_traces.png" title="High-Resolution Auto-Aligned Traces" ></p>

<p>That&rsquo;s all for now!
Coming up next time: cropping out just the interesting part of all the traces to build up a useful data set.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AVR, Meet Smart Card]]></title>
    <link href="http://www.gregmefford.com/blog/2010/06/05/avr-meet-smart-card/"/>
    <updated>2010-06-05T21:19:39-04:00</updated>
    <id>http://www.gregmefford.com/blog/2010/06/05/avr-meet-smart-card</id>
    <content type="html"><![CDATA[<p>As a part of my MS thesis research, I have a need to have precise control over an ACS ACOS5 Smart Card.
In this article, I will explain the code I have written to directly interface an Atmel ATtiny2313 microcontroller to an ACS ACOS5 cryptographic Smart Card.
Before developing this AVR C code, I experimented with various other methods of interfacing with a Smart Card at a low level, with varying amounts of success.
I will discuss some of the other methods in future articles, and outline how far I got with them and where there is still opportunity for improvement.</p>

<!-- more -->


<h2>Why a Microcontroller?</h2>

<p>My requirement was to have a simple, controllable interface to a Smart Card, with minimal cost as a design goal.
I started out trying to modify a commercial Smart Card reader to allow protocol analysis while under control of a computer.
While I was successful in modifying the reader to provide the physical interface, the API for getting low-level access to the card turned out to be difficult.
I decided that if I had to work with the PCSC API at the lowest level, I might as well just work from the card data sheet and implement as much of the protocol as I needed in C code for my $2 microcontroller.
This helped me to meet my controllability requirement by having full control over each byte transmitted and recieved between the card and the microcontroller.
It also helped me to meet a low-cost design goal by using a very inexpensive microcontroller instead of an expensive commercial reader that has been modified, plus a computer to drive it.</p>

<h2>Getting Started with an AVR</h2>

<p>To make prototyping simple, I bought a very helpful prototyping board for the Atmel ATtiny2313 microcontroller from <a href="http://www.evilmadscientist.com/article.php/card2313">Evil Mad Scientist</a>.
This board is great because it provides silk-screened labels of each IO pin function and plenty of plated through-holes for soldering interface wires and simple components like power supplies, filter capacitors, and resonators.
For connecting to a Smart Card, I picked up a Smart Card breakout board from <a href="http://www.sparkfun.com/commerce/product_info.php?products_id=9440">SparkFun Electronics</a>.
This breakout board offers a stanrdard physical interface to slide in a Smart Card and access its pins on plated through-holes, into which I mounted a row of standard single in-line pins that I could use for breadboarding and wiring up to the microcontroller breakout board.</p>

<p>To get a nice stable clock to the microcontroller (and ultimately to the Smart Card), I populated a 20 MHz ceramic resonator in the resonator footprint on the microcontroller breakout board.
To make use of this external clock, I calculated the appropriate bits using the ATtiny2313 data sheet and programmed the fuse bits as follows:</p>

<figure class='code'><figcaption><span>Configuring ATtiny2313 to Use a 20 MHz External Resonator </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">lfuse</span> <span class="o">=</span> <span class="mh">0xAF</span>
</span><span class='line'><span class="n">hfuse</span> <span class="o">=</span> <span class="mh">0xDF</span>
</span><span class='line'><span class="n">efuse</span> <span class="o">=</span> <span class="mh">0xFF</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Generating a Smart Card Clock</h2>

<p>The first requirement of interfacing the microcontroller to a Smart Card is to provide the card with a stable clock between 1 MHz and 5 MHz.
Even though the data IO interface of the ACOS5 Smart Card is asynchronous, the card requires a continuous clock on the CLK pin in order to operate.
This was accomplished rather simply using the ATtiny2313&rsquo;s hardware PWM function.
The PWM generator in the ATtiny2313 offers a lot of advanced features, but to simply generate a clock at a given frequency and duty cycle, most of the more advanced options are not required.
To generate a 2 MHz clock with a 50% duty cycle, I used the following simple function, adapted from the example code given in the data sheet for using the PWM generator:</p>

<figure class='code'><figcaption><span>Generate a 2 MHz Clock with 50% Duty Cycle </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span> <span class="nf">init_PWM_CLK</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// Generate a clock on OC0B pin.</span>
</span><span class='line'>  <span class="c1">// Compare Output Mode:</span>
</span><span class='line'>  <span class="n">TCCR0A</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">COM0B1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">COM0B0</span><span class="p">)</span> <span class="o">|</span> <span class="c1">// Toggle OC0B on Compare Match</span>
</span><span class='line'>           <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WGM01</span><span class="p">)</span>  <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">WGM00</span><span class="p">);</span>   <span class="c1">// Clear Timer on Compare Match</span>
</span><span class='line'>  <span class="n">TCCR0B</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">CS02</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">CS01</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CS00</span><span class="p">);</span> <span class="c1">// IO CLK, no pre-scalar</span>
</span><span class='line'>  <span class="n">OCR0A</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">// Freq. = 20MHz / 2*(1+ORC0A) = 2MHz</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I also made sure the data direction of the <code>OC0B</code> pin is set to output, so the clock will not default to a high-impedance input:</p>

<figure class='code'><figcaption><span>Configure the OC0B Pin as an Output </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">DDRD</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DDD5</span><span class="p">);</span> <span class="c1">// OC0B output pin</span>
</span><span class='line'>    <span class="n">init_PWM_CLK</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Answer to Reset</h2>

<p>Now that we have a clock to drive the Smart Card, the next thing to do is to perform the appropriate power-up sequence to cause the card to reset.
When the card resets, it transmits an Answer To Reset (ATR) string.
This string of bytes is used by commercial readers to identify the specific card being interfaced with, and describes its capabilities.
In this case, I read the ATR with an oscilloscope just to make sure the card is properly resetting, but I do not need the AVR to do anything based on the ATR, since I know the capabilities of the ACOS5 card that I am using for my research.</p>

<p>Since I do not need to actually read the bytes of the ATR sequence, I just use the following start-up sequence:</p>

<figure class='code'><figcaption><span>Smart Card Start-Up Sequence </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="c1">// Power-up procedure</span>
</span><span class='line'>  <span class="n">set_vpp</span><span class="p">();</span>
</span><span class='line'>  <span class="n">_delay_ms</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span><span class='line'>  <span class="n">set_reset</span><span class="p">();</span>
</span><span class='line'>  <span class="n">init_USART_RX</span><span class="p">();</span>
</span><span class='line'>  <span class="n">_delay_ms</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>set_vpp</code> and <code>set_reset</code> functions are just convenience methods to set the respective output pins high for the <code>VPP</code> and <code>RESET</code> pads on the Smart Card.
The <code>init_USART_RX</code> function is used to configure the built-in Universal Sychronous and Asynchronous serial Receiver and Transmitter (USART), which will be described in more detail in the following section.</p>

<h2>Data IO with USART</h2>

<p>A Microcontroller is a powerful tool for this type of low-level system integration because these very inexpensive processors generally come with built-in hardware support for a wide variety of serial protocols like Pulse-Width Modulation (PWM), I2C, and SPI.
These can be implemented using the AVR&rsquo;s USART and Universial Serial Interface (USI) ports, which support varying word lengths, start bits, stop bits, parity-generation, and parity-checking.</p>

<h3>Configuring the USART Interface</h3>

<p>For simplicity, the USART is configured to communicate at the default 9600 bps defined in the Smart Card standard.
I believe that the ACOS5 is also capable of communicating at 125 kbps, but I have not yet worked out the command to get it into that mode.
Both Answer to Reset (ATR) and the following communications will take place at 9600 bps unless configured to do otherwise.</p>

<p>The code to configure the USART interface is straightforward from the data sheet:</p>

<figure class='code'><figcaption><span>Configure the USART to Communicate with the Smart Card </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="kt">void</span> <span class="nf">init_USART_9600</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Baud rate</span>
</span><span class='line'>    <span class="c1">// UBRR = f_osc/(16*baud) - 1</span>
</span><span class='line'>    <span class="c1">// For 9600Hz, UBRR ~= 129.2 = 20000000/(16*9600) - 1</span>
</span><span class='line'>    <span class="n">UBRRH</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">UBRRL</span> <span class="o">=</span> <span class="mi">230</span><span class="p">;</span> <span class="c1">// 129 didn&#39;t look right on the oscilloscope. 230 works well.</span>
</span><span class='line'>    <span class="c1">// Set frame format: 8data, 1stop bit, even parity</span>
</span><span class='line'>    <span class="n">UCSRC</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">USBS</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">UCSZ0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">UPM1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since a Smart Card only has a single IO pad, I implemented the AVR&rsquo;s transceiver interface by connecting the IO pad of the card to both the AVR&rsquo;s TX and RX pins.
The direction of data on the IO line can then be controlled by software by activating and deactivating the USART&rsquo;s transmit and receieve modes exclusively.
When in receive mode, both the TX and RX pin on the microcontroller become high-impedance inputs, allowing the Smart Card to transmit.
In transmit mode, the microcontroller drives the TX pin, sending data to the Smart Card.
The C code to configure receive and transmit modes is  straightforward, based on the example code provided in the data sheet.
Since the transmit and receive modes are both enabled in the same control register, setting one without setting the other implicitly disables the latter.
The only other notable thing is that the <code>TXC</code> bit should be set when entering transmit mode to prevent the USART hardware from transmitting whatever byte happens to be already in the transmit buffer.</p>

<p>The code is as follows:</p>

<figure class='code'><figcaption><span>Configuring the USART for Transmit and Receive Modes </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="kt">void</span> <span class="nf">init_USART_RX</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Enable receiver</span>
</span><span class='line'>    <span class="n">UCSRB</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">RXEN</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="kt">void</span> <span class="nf">init_USART_TX</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Enable transmitter and tell it the buffer is empty.</span>
</span><span class='line'>    <span class="n">UCSRB</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TXEN</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TXC</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Transmitting and Receiving Bytes</h3>

<p>The transmit and receive processes are also straightforward.
The only thing to keep in mind is that the actual USART hardware is asynchronous to the rest of the running code.
That is, once a byte is written to the output buffer, the code continues to execute while the byte is transmitted in the background at the specified baud rate.
To simplify the code structure and avoid using interrupt call-back routines, my code keeps itself sychronous by waiting for each transmitted character to be flushed from the buffer before proceeding.
Similarly, the code to receive a character blocks until a character is received.
In one sense, this is dangerous because it could wait forever if the card became unresponsive when the interface was expecing a byte.
In practice, this should not be much of a problem for me because my research will exercise the card in controlled and well-known routines.</p>

<p>The transmit and receive code is as follows:</p>

<figure class='code'><figcaption><span>Transmitting and Receiving Data with the USART</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="kt">void</span> <span class="nf">USART_TX</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byte</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Clear the TX Complete flag by writing a 1 to it</span>
</span><span class='line'>    <span class="n">UCSRA</span> <span class="o">=</span> <span class="n">UCSRA</span> <span class="o">|</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TXC</span> <span class="p">);</span>
</span><span class='line'>    <span class="c1">// Wait until transmit buffer is ready</span>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="n">UCSRA</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">UDRE</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
</span><span class='line'>      <span class="p">;</span> <span class="c1">// Spin-lock</span>
</span><span class='line'>    <span class="c1">// Send the byte</span>
</span><span class='line'>    <span class="n">UDR</span> <span class="o">=</span> <span class="n">byte</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">USART_RX</span><span class="p">(</span> <span class="kt">void</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Wait until receive buffer is ready</span>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="n">UCSRA</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">RXC</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
</span><span class='line'>      <span class="p">;</span> <span class="c1">// Spin-lock</span>
</span><span class='line'>    <span class="c1">// Send the byte</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">UDR</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
</feed>
